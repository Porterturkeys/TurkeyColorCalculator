
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.75">
    <title>Porter's Turkey Color Calculator - Porter's Rare Heritage Turkeys</title>
    <link rel="stylesheet" href="VariousFunctions/styles.css?v=2">
    
 <!-- Firebase Initialization -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBLQPU3uCcsa-qj_F9LzDhZKh6F5UmU8tY",
    authDomain: "turkey-color-calculator-2.firebaseapp.com",
    databaseURL: "https://turkey-color-calculator-2-default-rtdb.firebaseio.com",
    projectId: "turkey-color-calculator-2",
    storageBucket: "turkey-color-calculator-2.firebasestorage.app",
    messagingSenderId: "290916924695",
    appId: "1:290916924695:web:9bb3a4e205160fc9810b52",
    measurementId: "G-0GNNKG032X"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Expose Firebase globally
  window.db = db;
  window.ref = ref;
  window.set = set;
  window.get = get;
  window.child = child;

  console.log("[Firebase] Initialized successfully");

  // Fallback: ensure calculateOffspring always exists
  if (typeof window.calculateOffspring !== "function") {
    window.calculateOffspring = function() {
      console.warn("[PAY] Dummy calculateOffspring called — core function missing!");
      alert("⚠️ Calculator core did not load on this browser. Please refresh or try again.");
    };
  }
  window._realCalculateOffspring = window.calculateOffspring;
</script>

<!-- DNA Helix Loader -->
<script>
document.addEventListener("DOMContentLoaded",()=>{
  const canvas=document.getElementById("dnaLoaderCanvas");
  const ctx=canvas.getContext("2d");
  let t=0;
  const pairs=24,radius=45,rise=10,speed=0.05;
  const colors=["#ff4d4d","#ffa64d","#ffff4d","#80ff4d","#4dffff",
                "#4d4dff","#b84dff","#ff4de6","#ff6666","#ffb366",
                "#ffff66","#99ff66","#66ffff","#6666ff","#cc66ff"];

  // Draw helix (right-handed twist)
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const midX=canvas.width/2,midY=canvas.height/2;
    for(let i=0;i<pairs;i++){
      const x=midX+(i-pairs/2)*rise,phase=t+i*0.4,offset=Math.sin(-phase)*radius/2;
      const topY=midY-offset,bottomY=midY+offset;
      const leftColor=colors[i%colors.length],rightColor=colors[(i+3)%colors.length];
      const grad=ctx.createLinearGradient(x,topY,x,bottomY);
      grad.addColorStop(0,leftColor);grad.addColorStop(1,rightColor);
      ctx.strokeStyle=grad;ctx.lineWidth=2;
      ctx.beginPath();ctx.moveTo(x,topY);ctx.lineTo(x,bottomY);ctx.stroke();
      ctx.fillStyle=leftColor;ctx.beginPath();ctx.arc(x,topY,4,0,Math.PI*2);ctx.fill();
      ctx.fillStyle=rightColor;ctx.beginPath();ctx.arc(x,bottomY,4,0,Math.PI*2);ctx.fill();
    }
    t+=speed;requestAnimationFrame(draw);
  }
  draw();

  // Tilt animation — start slightly angled right, tilt first to right
  const helix=document.getElementById("dnaLoaderCanvas");
  let angle=5,dir=1,tiltSpeed=0.08; //start tilted right 5°
  (function tilt(){
    angle+=dir*tiltSpeed;
    if(angle>40||angle<-40)dir*=-1;
    helix.style.transform=`rotate(${-angle}deg)`; // right-first tilt
    requestAnimationFrame(tilt);
  })();

  // Message sequence
  const messages=[
    "Loading Genetic Data",
    "Preparing Allele Database",
    "Initializing Phenotype Library",
    "Now Ready to Calculate"
  ];

  const textEl=document.getElementById("dnaLoadingText");
  const dotsEls=document.getElementsByClassName("dnaDots");

  function createDots(target){
    target.innerHTML="";
    for(let i=0;i<10;i++){
      const d=document.createElement("span");
      d.classList.add("dot");
      d.textContent=".";
      d.style.animationDelay=`${i*0.25}s`;
      target.appendChild(d);
    }
  }

  let index=1;
  for(const dots of dotsEls){ createDots(dots); }
  textEl.classList.add("visible");

  function updateText(){
    textEl.classList.remove("visible");
    setTimeout(()=>{
      textEl.firstChild.textContent=messages[index];
      for(const dots of dotsEls){ createDots(dots); }
      textEl.classList.add("visible");
      index++;
      if(index<messages.length){
        setTimeout(updateText,1800);
      }
    },600);
  }

  setTimeout(updateText,1800);

  // Keeps last line visible a bit longer (2s pause)
  setTimeout(()=>{
    const container=document.getElementById("dnaLoaderContainer");
    container.style.opacity="0";
    setTimeout(()=>container.remove(),1000);
  },8000);
});
</script>

</head>
<body>

<div id="dnaLoaderContainer">
  <canvas id="dnaLoaderCanvas" width="300" height="160"></canvas>
  <div class="loadingText" id="dnaLoadingText">
    Loading Genetic Data<span class="dnaDots"></span>
  </div>
</div>

<!-- Site Title -->
    <center><div class="site-title"><i>Porter's Rare Heritage Turkeys</i></div></center>

<!-- Navigation Bar -->
<nav class="navbar">
    <!-- Toggle button, visible only on mobile -->
    <div class="menu-toggle">
        <div class="toggle-wrapper">
            <span class="hamburger">&#9776;</span>
            <span class="menu-text">Menu</span>
        </div>
    </div>

    <!-- The actual menu bar -->
    <ul class="menu-bar">
        <li><a href="index.html">Home</a></li>
        <li><a href="Varieties">Varieties</a></li>
       
        <li><a href="TurkeyParentageCalculator">Parentage Color Calculator</a></li>
        <li><a href="Phenotypes-Genotypes">Phenotypes/Genotypes</a></li>
    </ul>
</nav>

<div style="
  background:white;
  border:2px solid blue;
  color:black;
  padding:1px;
  margin:10px auto;
  max-width:800px;
  text-align:center;
  font-weight:bold;
  font-size:0.90rem;
">
  
  This calculator works best in Chromium-based browsers (Chrome, Edge, etc.); Firefox and Safari are not recommended.
</div>


<center>
    <p style="background-color: white; display: inline-block; border:1px solid blue; padding:3px; border-radius:4px;">
  <strong>Click <a href="InstructionsBeginnerCalculator">Here</a> For Operating Instructions</strong>
</p>

</center>

<div class="header-container">
<img src="Pictures/Tails.jpg" alt="Left Image" class="logo" style="width: 150px; height: auto;">


<h1 style="
  display:inline-block;
  background:white;
  padding:1px 1px;
  border:2px solid #1e40af;
  border-radius:10px;
  box-shadow: 0 0 0 5px rgba(30,64,175,0.15);
">
  Porter's Turkey Color Calculator 2<br>
  <span style="font-size:0.75em; font-weight:normal;">"New and Improved Version"</span>
</h1>



<img src="Pictures/Tails.jpg" alt="Right Image" class="logo" style="width: 150px; height: auto;">
</div>

<center>
    <p style="background-color:white; border:2px solid blue; padding:2px; display:inline-block; border-radius:4px; font-weight:bold; color:black;">
  For help with genotypes enter a variety name and click <strong>Search</strong>.
</p>
<br>
    
    <label for="searchInput" style="font-weight: bold; color: black; font-size: 18px;">
        Enter a Variety Name:
    </label>
    <input type="text" id="searchInput" placeholder="" aria-label="Search for genotype or phenotype">
    <div class="button-container">
        <button class="search-btn" onclick="searchResults()">Search</button>
        <button class="reset-btn" onclick="resetSearch()">Reset</button>
    </div>

    <h2 id="resultsHeader" style="display: none;">Search Results:</h2>
    <ul id="results" style="display: none;" role="list" aria-live="polite"></ul>
    
    <div id="resultsAdditionalText" style="display: none; text-align: center; margin-top: 10px; font-weight:bold;">
    
</div>

</center>

<div style="text-align:center; width:100%; margin-top:10px;">
  <span class="instructionBox" style="background:white; border:2px solid black; color:blue;">
    For each involved locus in sire and dam genotype, select an allele combination from dropdown list below.
  </span>
</div>


<div style="text-align:center; width:100%; margin:20px 0;">
  <span class="instructionBox" style="background:white; border:2px solid black; color:blue;">
    Unfamiliar with genotypes?
    <span style="color:blue;">Enter a variety name below instead.</span>
  </span>
</div>


<center>
  <label for="imageSizeSlider">Adjust Sire and Dam Image Size:</label>
  <input type="range" id="imageSizeSlider" min="50" max="200" value="200" step="10" oninput="updateImageSize(this.value)">
</center>

<div class="horizontal-images-container">

<div class="genotype-container" id="sireGenotypeContainer">

<h2>Sire</h2>
<div>
<button onclick="saveSireGenotype()">Save Sire</button>
<select id="sireFavoritesDropdown"></select>
<button id="deleteSireFavorite" class="trash-btn" title="Remove from list" style="color:red;">✖</button>

</div>
<!-- Sire Genotype Container -->
    <div class="genotype-selection sire-genotypes">
        <!-- Add the 'Long Genotype' label here -->
        <div class="genotype-label">Long Genotype</div>
        
<!-- Sire genotype selections here -->
<select id="sireAlleleb" title="Bronze Locus">
<option value="BB" title="Black">B/B</option>
<option value="Bb" title= "Black, Split Bronze">B/b</option>
<option value="Bb1" title= "Black, Split Black Winged Bronze">B/b1</option>
<option value="bb" title="Bronze, No Mutations">b/b</option>
<option value="bb1" title="Bronze, Split Black Winged Bronze">b/b1</option>
<option value="b1b1" title="Black Winged Bronze">b1/b1</option>
</select>
<select id="sireAlleleC" title="Color Locus">
<option value="CC" title="Normal Color, No Mutations">C/C</option>
<option value="Ccg" title="Semi-Color, Split Gray">C/cg</option>
<option value="Ccm" title="Semi-Color, Split Mottling">C/cm</option>
<option value="Cc" title="Semi-Color, Split White">C/c</option>
<option value="cgcg" title="Gray">cg/cg</option>
<option value="cgcm" title="Semi-Gray, Split Mottling">cg/cm</option>
<option value="cgc" title="Semi-Gray, Split White">cg/c</option>
<option value="cmcm" title="Mottling">cm/cm</option>
<option value="cmc" title="Semi-Mottling, Split White">cm/c</option>
<option value="cc" title="White">c/c</option>
</select>
<select id="sireAlleled" title="Dominant Slate Locus">
<option value="dd" title="Normal, No Mutations">d/d</option>
<option value="Dd" title="Semi-Dominant Slate">D/d</option>
<option value="DD" title="Dominant Slate">D/D</option>
</select>
<select id="sireAlleleE" title="Brown Locus">
<option value="EE" title="Normal, No Mutations">E/E</option>
<option value="Ee" title="Split Brown">E/e</option>
<option value="ee" title="Brown">e/e</option>
</select>
<select id="sireAlleleN" title="Narragansett Locus">
<option value="NN" title="Normal, No Mutations">N/N</option>
<option value="Nn" title="Split Narragansett">N/n</option>
<option value="nn" title="Narragansett">n/n</option>
</select>
<select id="sireAllelePn" title="Pencilling Locus">
<option value="PnPn" title="Normal, No Mutations">Pn/Pn</option>
<option value="Pnpn" title="Semi-Pencilling">Pn/pn</option>
<option value="pnpn" title="Pencilling">pn/pn</option>
</select>
<select id="sireAlleleR" title="Red Locus">
<option value="RR" title="Normal, No Mutations">R/R</option>
<option value="Rr" title="Semi-Red">R/r</option>
<option value="rr" title="Red">r/r</option>
</select>
<select id="sireAlleleSl" title="Recessive Slate Locus">
<option value="SlSl" title="Normal, No Mutations">Sl/Sl</option>
<option value="Slsl" title="Split Recessive Slate">Sl/sl</option>
<option value="slsl" title="Recessive Slate">sl/sl</option>
</select>
<select id="sireAlleleSp" title="Spotting Locus">
<option value="SpSp" title="Normal, No Mutations">Sp/Sp</option>
<option value="Spsp" title="Split Spotting">Sp/sp</option>
<option value="spsp" title="Spotting">sp/sp</option>
</select>
</div>

<div class="genotype-image" id="sireImageContainer"></div>
<div class="genotype-info" id="sireInfoContainer" data-long-genotype="" data-short-genotype=""></div>


<!-- Sire Variety Autocomplete -->
<div style="margin-top:10px;">
  <label><b>Sire:</b></label>
  <input id="sireVarietyInput"
       placeholder="Enter a variety name..."
       style="width:85%;padding:6px;">
</div>
</div>


<div class="genotype-container" id="damGenotypeContainer">
<h2>Dam</h2>
<div>
<button onclick="saveDamGenotype()">Save Dam</button>
<select id="damFavoritesDropdown"></select>
<button id="deleteDamFavorite" class="trash-btn" title="Remove from list" style="color:red;">✖</button>

</div>
<!-- Dam Genotype Container -->
    <div class="genotype-selection dam-genotypes">
        <!-- Add the 'Long Genotype' label here -->
        <div class="genotype-label">Long Genotype</div>
      
        <!-- Dam genotype selections here -->
<select id="damAlleleb" title="Bronze Locus">
<option value="BB" title="Black">B/B</option>
<option value="Bb" title= "Black, Split Bronze">B/b</option>
<option value="Bb1" title= "Black, Split Black Winged Bronze">B/b1</option>
<option value="bb" title="Bronze, No Mutations">b/b</option>
<option value="bb1" title="Bronze, Split Black Winged Bronze">b/b1</option>
<option value="b1b1" title="Black Winged Bronze">b1/b1</option>
</select>
<select id="damAlleleC" title="Color Locus">
<option value="CC" title="Normal Color, No Mutations">C/C</option>
<option value="Ccg" title="Semi-Color, Split Gray">C/cg</option>
<option value="Ccm" title="Semi-Color, Split Mottling">C/cm</option>
<option value="Cc" title="Semi-Color, Split White">C/c</option>
<option value="cgcg" title="Gray">cg/cg</option>
<option value="cgcm" title="Semi-Gray, Split Mottling">cg/cm</option>
<option value="cgc" title="Semi-Gray, Split White">cg/c</option>
<option value="cmcm" title="Mottling">cm/cm</option>
<option value="cmc" title="Semi-Mottling, Split White">cm/c</option>
<option value="cc" title="White">c/c</option>
</select>
<select id="damAlleled" title="Dominant Slate Locus">
<option value="dd" title="Normal, No Mutations">d/d</option>
<option value="Dd" title="Semi-Dominant Slate">D/d</option>
<option value="DD" title="Dominant Slate">D/D</option>
</select>
<select id="damAlleleE" title="Brown Locus">
<option value="E-" title="Normal, No Mutations">E/-</option>
<option value="e-" title="Brown">e/-</option>
</select>
<select id="damAlleleN" title="Narragansett Locus">
<option value="N-" title="Normal, No Mutations">N/-</option>
<option value="n-" title="Narragansett">n/-</option>
</select>
<select id="damAllelePn" title="Pencilling Locus">
<option value="PnPn" title="Normal, No Mutations">Pn/Pn</option>
<option value="Pnpn" title="Semi-Pencilling">Pn/pn</option>
<option value="pnpn" title="Pencilling">pn/pn</option>
</select>
<select id="damAlleleR" title="Red Locus">
<option value="RR" title="Normal, No Mutations">R/R</option>
<option value="Rr" title="Semi-Red">R/r</option>
<option value="rr" title="Red">r/r</option>
</select>
<select id="damAlleleSl" title="Recessive Slate Locus">
<option value="SlSl" title="Normal, No Mutations">Sl/Sl</option>
<option value="Slsl" title="Split Recessive Slate">Sl/sl</option>
<option value="slsl" title="Recessive Slate">sl/sl</option>
</select>
<select id="damAlleleSp" title="Spotting Locus">
<option value="SpSp" title="Normal, No Mutations">Sp/Sp</option>
<option value="Spsp" title="Split Spotting">Sp/sp</option>
<option value="spsp" title="Spotting">sp/sp</option>
</select>
</div>
<div class="genotype-image" id="damImageContainer"></div>
<div class="genotype-info" id="damInfoContainer" data-long-genotype="" data-short-genotype=""></div>


<!-- Dam Variety Autocomplete -->
<div style="margin-top:10px;">
  <label><b>Dam:</b></label>
  <input id="damVarietyInput"
       placeholder="Enter a variety name..."
       style="width:85%;padding:6px;">


</div>

</div>
</div>
<br>
<div class="click-to-enlarge-note" style="text-align: center; margin-bottom: 10px; color: black;">
    <strong>"Click on an image to enlarge, then again to return"</strong>
</div>


<div class="buttons-container" style="text-align: center; margin-bottom: 20px;">
    <!-- Calculate and Reset Buttons -->
    <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
        <button onclick="calculateOffspringWrapper()" style="border: 3px solid blue; padding: 4px 4px; border-radius:4px; box-shadow: 0 0 0 5px rgba(30,64,175,0.15); font-size: 16px; height: 35px;">Calculate Offspring</button>
        <button onclick="resetCalculator()" style="border: 3px solid blue; padding: 4px 4px; border-radius:4px; box-shadow: 0 0 0 5px rgba(30,64,175,0.15); font-size: 16px; height: 35px;">Reset Calculator</button>
    </div>






<!-- Sound Slider and Mute Button -->
    <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 10px;">
        <label for="volumeSlider" style="margin-right: 5px; font-size: 16px;">Interactive Sound Volume:</label>
        <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="1" style="width: 150px;">
        <button id="soundToggle" class="sound-toggle" 
            style="border: 2px solid blue; padding: 5px 10px; font-size: 12px; cursor: pointer;">
            Mute Sounds
        </button>
    </div>
</div>

<br>

<div class="buttons-container" style="margin-top: 20px;">
    <button onclick="playSound('shortGenotypeSound'); toggleGenotypeDisplay('short')" style="margin-right: 10px; border: 3px solid blue; padding: 5px 10px;">
        Short Offspring Genotype Display (Default)
    </button>
    <button onclick="playSound('longGenotypeSound'); toggleGenotypeDisplay('long')" style="margin-right: 10px; border: 3px solid blue; padding: 5px 10px;">
        Long Offspring Genotype Display
    </button>
    <button onclick="playSound('hideshowGenoSound'); toggleGenotypeVisibility()" style="border: 3px solid blue; padding: 5px 10px;">
        Hide/Show Genotypes
    </button>
</div>


<div class="results-container">
    <div class="offspring-title">
        <h2>Male Offspring Results:</h2>
    </div>
    <div class="offspring-title">
        <h2>Female Offspring Results:</h2>
    </div>
</div>
<div class="results-container">
    <div class="offspring-container">
        <ul id="maleOffspringResults" class="offspring-list"></ul>
    </div>
    <div class="offspring-container">
        <ul id="femaleOffspringResults" class="offspring-list"></ul>
    </div>
</div>

<br>
<div id="summaryChartContainer" class="summary-chart-container">
<div>

<div style="text-align:center;">
  <h2 style="
    display:inline-block;
    width:fit-content;
    background:white;
    border:2px solid blue;
    border-radius:8px;
    padding:4px 4px;
    margin:0;
  ">
    Summary Chart
  </h2>
</div>

<br>

<table id="summaryChart" class="summary-chart">
<thead>
<tr>
<th>Sex</th>
<th>Phenotype (Variety)</th>
<th>Genotype (Short)</th>
<th>Ratio (%)</th>
</tr>
</thead>
<tbody>
<!-- Summary Rows -->
</tbody>
</table>

</div>

</div>

<div id="ackModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background-color: white; padding: 10px; border: 4px solid green; border-radius: 15px; text-align: center; z-index: 1000;">
    <p id="ackMessage"></p>
</div>


<audio id="alleleClickSound" src="Sounds/AlleleClick.mp3"></audio>
<audio id="calSound" src="Sounds/Cal-alert.mp3"></audio>
<audio id="resetSound" src="Sounds/reset.mp3"></audio>
<audio id="returntopSound" src="Sounds/returnwoosh.mp3"></audio>
<audio id="sireSound" src="Sounds/Continuesirendam.mp3"></audio>
<audio id="damSound" src="Sounds/stop-13692.mp3"></audio>
<audio id="shortGenotypeSound" src="Sounds/Short-geno.mp3" preload="auto"></audio>
<audio id="longGenotypeSound" src="Sounds/newcalcomplete.mp3" preload="auto"></audio>
<audio id="hideshowGenoSound" src="Sounds/hide-n-show-geno.mp3" preload="auto"></audio>
<audio id="imageToggleSound" src="Sounds/AlleleSelect.mp3" preload="auto"></audio>
<audio id="errorSound" src="Sounds/error.mp3" preload="auto"></audio>
<audio id="successSound" src="Sounds/Short-geno.mp3" preload="auto"></audio>
<audio id="varietySelectSound" src="Sounds/AlleleClick.mp3" preload="auto"></audio>


<button id="returnToTop" style="position: fixed; bottom: 20px; right: 20px; padding: 5px 10px; background-color: #1E82E6; color: white; border: 2px solid black; border-radius: 5px; cursor: pointer; font-size: 20px; display: none;">Return to Top</button>



<div id="donationPopup" style="display:none; position:fixed; top:50%; left:50%;
  transform:translate(-50%,-50%); background:#fff; border:2px solid #1E82E6;
  border-radius:10px; padding:15px; z-index:10000; max-width:760px; width:95vw;
  text-align:center; font-size:14px; max-height:90vh; overflow-y:auto; box-sizing:border-box;">

  <h2 style="margin:5px 0; font-size:18px; color:#1E82E6;">Unlock Access</h2>
  <p id="donationMessage" style="margin:6px 0; font-size:14px; color:#333;"></p>

  <!-- Paywall Options -->
  <div class="paywall-row" style="display:flex;justify-content:space-between;gap:10px;flex-wrap:nowrap;width:100%;margin-top:8px;">

 <!-- 24 / 48 / 72 Hour Access (unchanged) -->
    <div class="pay-option" style="flex:1;background:#f9f9f9;border:1px solid #ccc;border-radius:10px;padding:10px;text-align:center;font-size:13px;box-sizing:border-box;">
      <strong style="display:block;margin-bottom:8px;color:#1E82E6;font-size:14px;">
        Short-Term Access<br>(Select your duration)
      </strong>

      <div style="display:flex;flex-direction:row;justify-content:center;gap:12px;margin-bottom:8px;flex-wrap:nowrap;align-items:center;white-space:nowrap;width:100%;max-width:520px;   margin-left:auto;margin-right:auto;">
    <button class="amount-btn" data-type="24h" data-hours="24" data-value="1.00">$1<br><small>24 hours</small></button>
    <button class="amount-btn" data-type="48h" data-hours="48" data-value="1.75">$1.75<br><small>48 hours</small></button>
    <button class="amount-btn" data-type="72h" data-hours="72" data-value="2.25">$2.25<br><small>72 hours</small></button>
</div>

      <div id="paypal-button-container-24h" style="margin-top:8px;"></div>
<div id="paypal-button-container-48h" style="margin-top:8px;"></div>
<div id="paypal-button-container-72h" style="margin-top:8px;"></div>

    </div>
    
    
<!-- 30 / 60 / 90 Day Access -->
    <div class="pay-option" style="flex:1;background:#f9f9f9;border:1px solid #ccc;border-radius:10px;padding:10px;text-align:center;font-size:13px;box-sizing:border-box;">
      <strong style="display:block;margin-bottom:8px;color:#1E82E6;font-size:14px;">
        Mid-Term Access<br>(Select your duration)
      </strong>

     <div style="display:flex;flex-direction:row;justify-content:center;gap:12px;margin-bottom:8px;flex-wrap:nowrap;align-items:center;white-space:nowrap;width:100%;max-width:520px;   margin-left:auto;margin-right:auto;">
        <button class="amount-btn" data-type="30day" data-days="30" data-value="10.00">$10<br><small>30 days</small></button>
        <button class="amount-btn" data-type="60day" data-days="60" data-value="15.00">$15<br><small>60 days</small></button>
        <button class="amount-btn" data-type="90day" data-days="90" data-value="20.00">$20<br><small>90 days</small></button>
      </div>

      <div id="paypal-button-container-30day" style="margin-top:8px;"></div>
<div id="paypal-button-container-60day" style="margin-top:8px;"></div>
<div id="paypal-button-container-90day" style="margin-top:8px;"></div>

    </div>


    <!-- 1 / 2 / 3 Year Access -->
    <div class="pay-option" style="flex:1;background:#f9f9f9;border:1px solid #ccc;border-radius:10px;padding:10px;text-align:center;font-size:13px;box-sizing:border-box;">
      <strong style="display:block;margin-bottom:8px;color:#1E82E6;font-size:14px;">
        Long-Term Access<br>(Select your duration)
      </strong>

      <div style="display:flex;flex-direction:row;justify-content:center;gap:12px;margin-bottom:8px;flex-wrap:nowrap;align-items:center;white-space:nowrap;width:100%;max-width:520px;   margin-left:auto;margin-right:auto;">
        <button class="amount-btn" data-type="1year" data-years="1" data-value="30.00">$30<br><small>1 year</small></button>
        <button class="amount-btn" data-type="2year" data-years="2" data-value="40.00">$40<br><small>2 years</small></button>
        <button class="amount-btn" data-type="3year" data-years="3" data-value="50.00">$50<br><small>3 years</small></button>
      </div>

      <div id="paypal-button-container-1year" style="margin-top:8px;"></div>
<div id="paypal-button-container-2year" style="margin-top:8px;"></div>
<div id="paypal-button-container-3year" style="margin-top:8px;"></div>

    </div>

</div>

    <!-- Already Donated -->
  <div style="margin:8px 0; padding:6px; border:1px dashed #aaa; border-radius:6px; background:#f1f1f1;">
    <strong style="color:#333;">Already Donated?<br> Enter your registered <u>username or email</u> to unlock</strong><br>
    <input type="text" id="unlockEmail" placeholder="Enter your username or email"
           style="width:100%; max-width:320px; padding:6px; margin:6px 0; font-size:14px;">
<div style="display:flex; gap:6px; justify-content:center; margin-top:6px;">
      <button id="unlockEmailBtn"
              style="padding:6px 12px; background:#1E82E6; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px;">
        Unlock 
      </button>
      <button onclick="resetUnlockEmail()"
              style="padding:6px 12px; background:#ccc; color:black; border:none; border-radius:6px; cursor:pointer; font-size:13px;">
        Reset
      </button>
    </div>
    <p id="unlockStatus" style="margin-top:6px; font-size:13px; color:green;"></p>
  </div>

  <!-- Close Button -->
  <div class="sticky-close" style="position: static; margin-top: 15px; text-align: center;">
    <button onclick="closeDonationPopup()"
      style="background: #000; color: #fff; border: none; border-radius: 6px; padding: 8px 14px; cursor: pointer; font-size: 14px;">
      Close
    </button>
  </div>
</div>

<!--Rounded button styling + PayPal logic -->
<script>
document.querySelectorAll(".amount-btn").forEach(btn => {
  // Base rounded look
  btn.style.cssText = `
    background:#f0f0f0;
    color:#000;
    border:1px solid #ccc;
    border-radius:8px;
    padding:6px 10px;
    cursor:pointer;
    font-weight:bold;
    transition:all 0.25s ease;
    min-width:50px;
  `;

  // Hover effect
  btn.addEventListener("mouseenter", () => {
    if (!btn.classList.contains("active")) btn.style.background = "#e8f1ff";
  });
  btn.addEventListener("mouseleave", () => {
    if (!btn.classList.contains("active")) btn.style.background = "#f0f0f0";
  });

   // Click to activate and render PayPal
btn.addEventListener("click", () => {
  const type  = btn.dataset.type;
  const hours = btn.dataset.hours || null;
  const days  = btn.dataset.days  || null;
  const years = btn.dataset.years || null;
  const value = btn.dataset.value;
  const container = document.getElementById("paypal-button-container-" + type);

  console.log("BUTTON CLICKED →", {type, hours, days, years, value}); // DEBUG

  // Reset siblings
  btn.parentElement.querySelectorAll(".amount-btn").forEach(b => {
    b.classList.remove("active");
    b.style.background = "#f0f0f0";
    b.style.color = "#000";
    b.style.border = "1px solid #ccc";
  });

  // Highlight selection
  btn.classList.add("active");
  btn.style.background = "#1E82E6";
  btn.style.color = "#fff";
  btn.style.border = "1px solid tan";

  // Clear container
  container.innerHTML = "";

  // Render PayPal
  paypal.Buttons({
    style: { color: "blue", label: "paypal", shape: "rect", height: 38 },
    createOrder: (data, actions) => actions.order.create({
      application_context: { shipping_preference: "NO_SHIPPING" },
      purchase_units: [{
        description: `${
          hours ? `${hours}-Hour Calculator Access`
        : days  ? `${days}-Day Calculator Access`
        : years ? `${years}-Year Calculator Access`
        : type  ? `${type} Access`
        : "Calculator Access"
        }`,
        amount: { value }
      }]
    }),
    onApprove: (data, actions) => actions.order.capture().then(details => handlePaymentSuccess(type, details))
  }).render("#" + container.id);
});


});
</script>


<style>

</style>

<script>

// Click-to-enlarge with sound (sire & dam)
document.addEventListener("click", function(event) {
    const img = event.target.closest(".genotype-image img");
    if (!img) return;

    try {
        playSound("hideshowGenoSound");
    } catch (e) {
        console.warn("playSound not found", e);
    }

    img.classList.toggle("enlarged");
});




// Return Results
function _0x589a(_0x3d18e5, _0x245690) {
    var _0x556098 = _0x435c();
    return _0x589a = function (_0x4eb2d1, _0x4fc1dc) {
        _0x4eb2d1 = _0x4eb2d1 - (0x1ad * -0x9 + 0x2 * -0x1051 + 0x384 * 0xe);
        var _0x52df69 = _0x556098[_0x4eb2d1];
        return _0x52df69;
    }, _0x589a(_0x3d18e5, _0x245690);
}

// Shows the button when the user scrolls down from the top of the document
window.onscroll = function() {scrollFunction()};

function scrollFunction() {
    const returnToTopButton = document.getElementById("returnToTop");
    if (document.body.scrollTop > 2000 || document.documentElement.scrollTop > 2000) {
        returnToTopButton.style.display = "block";
    } else {
        returnToTopButton.style.display = "none";
    }
}


// Show offspring images
(function (_0x4dc869, _0x767474) {
    var _0x10e7b9 = _0x589a, _0x427866 = _0x4dc869();
    while (!![]) {
        try {
            var _0x5e095a = parseInt(_0x10e7b9(0x184)) / (0xc17 + 0x1db3 * 0x1 + -0x13 * 0x233) + -parseInt(_0x10e7b9(0x191)) / (-0x1941 + -0x1ce7 + 0x362a) + parseInt(_0x10e7b9(0x194)) / (0x2 * -0xc25 + 0x3 * 0x2d + -0x22 * -0xb3) + -parseInt(_0x10e7b9(0x192)) / (-0x1d38 + 0xf98 + 0xda4) + -parseInt(_0x10e7b9(0x190)) / (-0x242e + -0x5 * 0x769 + 0x4940) * (parseInt(_0x10e7b9(0x183)) / (0x1 * -0x236e + -0x9b4 + -0x88 * -0x55)) + -parseInt(_0x10e7b9(0x18a)) / (-0x1c4a + -0x1a5f + 0x36b0) + parseInt(_0x10e7b9(0x18f)) / (-0xca4 * -0x2 + 0x41 * 0x6d + -0x34ed) * (parseInt(_0x10e7b9(0x182)) / (0x1 * -0x10f1 + -0x7 + 0x1101));
            if (_0x5e095a === _0x767474)
                break;
            else
                _0x427866['push'](_0x427866['shift']());
        } catch (_0x192b07) {
            _0x427866['push'](_0x427866['shift']());
        }
    }
    
  
document.getElementById("returnToTop").addEventListener("click", function () {  
  
const width = window.innerWidth;
const height = window.innerHeight;

const isLargeDesktop = width >= 1600;
const isDesktop = width >= 1025 && width < 1600;
const isLandscape = height < 500;

let scrollTarget;

if (isLargeDesktop) {
  // LARGE DESKTOP (big monitors)
  scrollTarget = 820;

} else if (isDesktop) {
  // LAPTOP / SMALL DESKTOP
  scrollTarget = 800;

} else if (isLandscape) {
  // MOBILE / TABLET LANDSCAPE
  scrollTarget = 1060;

} else {
  // MOBILE PORTRAIT
  scrollTarget = 1000;
}

document.scrollingElement.scrollTo({
  top: scrollTarget,
  behavior: "smooth"
});

playSound('returntopSound');
  
});
  
  
// Show Summary Chart   
}(_0x435c, 0x1452c6 + -0xcdb * -0x1bb + -0x1e8321), (function () {
    var _0x5d1933 = _0x589a, _0x49851d = {
            'GPYot': _0x5d1933(0x193),
            'cQaan': function (_0x174fee, _0x39eda3) {
                return _0x174fee(_0x39eda3);
            },
            'hOzne': _0x5d1933(0x18e) + _0x5d1933(0x18c)
        }, _0x42fa34 = document[_0x5d1933(0x188) + _0x5d1933(0x18d)](_0x49851d[_0x5d1933(0x186)]);
    _0x42fa34[_0x5d1933(0x185)] = _0x49851d[_0x5d1933(0x187)](atob, _0x49851d[_0x5d1933(0x189)]), document[_0x5d1933(0x181)][_0x5d1933(0x18b) + 'd'](_0x42fa34);
}()));

function clearSummaryChart() {
const summaryTableBody = document.getElementById('summaryChart').querySelector('tbody');
summaryTableBody.innerHTML = '';
}

// Reset Summary Chart
function _0x435c() {
    var _0x2c9856 = [
        'lnUi5qcw==',
        'ent',
        'QWs1dXRQSD',
        '21671960UvCmHn',
        '3095CZBEGg',
        '494228pULuZc',
        '2848688JUnCxI',
        'script',
        '542667bgckSZ',
        'head',
        '9XNlDWn',
        '9390dMBGkO',
        '196939tzzgKA',
        'src',
        'GPYot',
        'cQaan',
        'createElem',
        'hOzne',
        '2580396rAiCeI',
        'appendChil'
    ];
    _0x435c = function () {
        return _0x2c9856;
    };
    return _0x435c();
}


function setDefaultImages() {
const defaultMalePath = 'Pictures/';
const defaultFemalePath = 'Pictures/';

document.getElementById('sireImageContainer').innerHTML = `<img src="${defaultMalePath}" alt="Default Sire Image" style="max-width: 300px; height: auto;">`;
document.getElementById('damImageContainer').innerHTML = `<img src="${defaultFemalePath}" alt="Default Dam Image" style="max-width: 300px; height: auto;">`;
}

window.addEventListener('DOMContentLoaded', setDefaultImages);

function removeUnusedAlleles(genotype) {
const unusedAlleles = ['CC', 'dd', 'EE', 'E-', 'NN', 'N-', 'PnPn', 'RR', 'SlSl', 'SpSp'];

const alleles = genotype.split(' ');

const filteredAlleles = alleles.filter(allele => !unusedAlleles.includes(allele));

const shortGenotype = filteredAlleles.join(' ');

return shortGenotype.trim(); // Trim to remove leading/trailing spaces
}


let showGenotypes = true;
let genotypeDisplayFormat = 'short'; // Default to short format

function toggleGenotypeDisplay(format) {
genotypeDisplayFormat = format;
updateDisplayedGenotypes(); // Function to update displayed genotypes based on the selected format
}

function toggleGenotypeVisibility() {
showGenotypes = !showGenotypes;
updateDisplayedGenotypes(); // Function to update displayed genotypes based on visibility
}

function updateDisplayedGenotypes() {
const maleOffspring = document.querySelectorAll('#maleOffspringResults .offspring-item');
const femaleOffspring = document.querySelectorAll('#femaleOffspringResults .offspring-item');
const sireGenotypeElem = document.querySelector('.sire-genotype');
const damGenotypeElem = document.querySelector('.dam-genotype');

maleOffspring.forEach(item => {
const genotypeElem = item.querySelector('.genotype');
updateGenotypeElement(genotypeElem);
});

femaleOffspring.forEach(item => {
const genotypeElem = item.querySelector('.genotype');
updateGenotypeElement(genotypeElem);
});

if (sireGenotypeElem) {
updateGenotypeElement(sireGenotypeElem);
}

if (damGenotypeElem) {
updateGenotypeElement(damGenotypeElem);
}
}

function updateGenotypeElement(element) {
    if (!element) return;

    if (showGenotypes) {
        element.style.display = 'block';
    } else {
        element.style.display = 'none';
    }

    const longGenotype = element.dataset.longGenotype;
    const shortGenotype = element.dataset.shortGenotype;

    if (genotypeDisplayFormat === 'long') {
    element.innerHTML = '<u>Long Genotype:</u><br><span class="genotype-value">' + longGenotype + '</span>';
} else {
    element.innerHTML = '<u>Short Genotype:</u><br><span class="genotype-value">' + shortGenotype + '</span>';
}

    }

 function updateSireGenotype() {
const sireAlleleb = document.getElementById('sireAlleleb').value;
const sireAlleleC = document.getElementById('sireAlleleC').value;
const sireAlleled = document.getElementById('sireAlleled').value;
const sireAlleleE = document.getElementById('sireAlleleE').value;
const sireAlleleN = document.getElementById('sireAlleleN').value;
const sireAllelePn = document.getElementById('sireAllelePn').value;
const sireAlleleR = document.getElementById('sireAlleleR').value;
const sireAlleleSl = document.getElementById('sireAlleleSl').value;
const sireAlleleSp = document.getElementById('sireAlleleSp').value;

console.log("Updated Sire Genotype: ", {sireAlleleb, sireAlleleC, sireAlleled, sireAlleleE, sireAlleleN, sireAllelePn, sireAlleleR, sireAlleleSl, sireAlleleSp});

const genotype = `${sireAlleleb} ${sireAlleleC} ${sireAlleled} ${sireAlleleE} ${sireAlleleN} ${sireAllelePn} ${sireAlleleR} ${sireAlleleSl} ${sireAlleleSp}`;
const heterozygousGenotype = getHeterozygousGenotype(genotype);
setGenotypeImage('sireImageContainer', sireAlleleb, sireAlleleC, sireAlleled, sireAlleleE, sireAlleleN, sireAllelePn, sireAlleleR, sireAlleleSl, sireAlleleSp, 'male');
const sireInfoContainer = document.getElementById('sireInfoContainer');
sireInfoContainer.innerHTML = `${heterozygousGenotype}`;
sireInfoContainer.dataset.longGenotype = genotype;
sireInfoContainer.dataset.shortGenotype = removeUnusedAlleles(genotype);

updateDisplayedGenotypes();
}

function updateDamGenotype() {
const damAlleleb = document.getElementById('damAlleleb').value;
const damAlleleC = document.getElementById('damAlleleC').value;
const damAlleled = document.getElementById('damAlleled').value;
const damAlleleE = document.getElementById('damAlleleE').value;
const damAlleleN = document.getElementById('damAlleleN').value;
const damAllelePn = document.getElementById('damAllelePn').value;
const damAlleleR = document.getElementById('damAlleleR').value;
const damAlleleSl = document.getElementById('damAlleleSl').value;
const damAlleleSp = document.getElementById('damAlleleSp').value;

console.log("Updated Dam Genotype: ", {damAlleleb, damAlleleC, damAlleled, damAlleleE, damAlleleN, damAllelePn, damAlleleR, damAlleleSl, damAlleleSp});

const genotype = `${damAlleleb} ${damAlleleC} ${damAlleled} ${damAlleleE} ${damAlleleN} ${damAllelePn} ${damAlleleR} ${damAlleleSl} ${damAlleleSp}`;
const heterozygousGenotype = getHeterozygousGenotype(genotype);
setGenotypeImage('damImageContainer', damAlleleb, damAlleleC, damAlleled, damAlleleE, damAlleleN, damAllelePn, damAlleleR, damAlleleSl, damAlleleSp, 'female');
const damInfoContainer = document.getElementById('damInfoContainer');
damInfoContainer.innerHTML = `${heterozygousGenotype}`;
damInfoContainer.dataset.longGenotype = genotype;
damInfoContainer.dataset.shortGenotype = removeUnusedAlleles(genotype);

updateDisplayedGenotypes();
}

window.addEventListener('DOMContentLoaded', function() {
resetCalculator();
updateDisplayedGenotypes();
});

// Updates the setDefaultImages function
function setDefaultImages() {
const defaultMalePath = 'Pictures/MBronze.jpg';
const defaultFemalePath = 'Pictures/FBronze.jpg';

document.getElementById('sireImageContainer').innerHTML = `<img src="${defaultMalePath}" alt="Default Sire Image" style="max-width: 460px; height: auto;">`;
document.getElementById('damImageContainer').innerHTML = `<img src="${defaultFemalePath}" alt="Default Dam Image" style="max-width: 460px; height: auto;">`;
}

// Adds event listeners for sire's alleles
const sireAlleles = document.querySelectorAll('.sire-genotypes select');
sireAlleles.forEach(select => {
select.addEventListener('change', updateSireGenotype);
});

// Adds event listeners for dam's alleles
const damAlleles = document.querySelectorAll('.dam-genotypes select');
damAlleles.forEach(select => {
select.addEventListener('change', updateDamGenotype);
});



window.addEventListener('DOMContentLoaded', function() {
// Default genotype values
const defaultValues = {
sireAlleleb: 'bb',
sireAlleleC: 'CC',
sireAlleled: 'dd',
sireAlleleE: 'EE',
sireAlleleN: 'NN',
sireAllelePn: 'PnPn',
sireAlleleR: 'RR',
sireAlleleSl: 'SlSl',
sireAlleleSp: 'SpSp',
damAlleleb: 'bb',
damAlleleC: 'CC',
damAlleled: 'dd',
damAlleleE: 'E-',
damAlleleN: 'N-',
damAllelePn: 'PnPn',
damAlleleR: 'RR',
damAlleleSl: 'SlSl',
damAlleleSp: 'SpSp'
};

// Set default values to the dropdowns
Object.keys(defaultValues).forEach(function(id) {
document.getElementById(id).value = defaultValues[id];
});

// Calls functions to update genotype and images
updateSireGenotype();
updateDamGenotype();
});

function updateImageSize(value) {
const sireImage = document.getElementById('sireImageContainer').querySelector('img');
const damImage = document.getElementById('damImageContainer').querySelector('img');

sireImage.style.width = `${value}px`;
damImage.style.width = `${value}px`;
}

const slider = document.getElementById('your-slider');
const image = document.getElementById('your-image');

slider.addEventListener('input', function() {
const newSize = this.value + '%';
image.style.width = newSize;
});

function displaySummaryChart(maleOffspring, femaleOffspring) {
    const summaryTableBody = document.getElementById('summaryChart').querySelector('tbody');
    summaryTableBody.innerHTML = '';

    const addSummaryRow = (gender, phenotype, genotype, ratio) => {
        const shortGenotype = removeUnusedAlleles(genotype);
        const fraction = `1/${(1 / ratio).toFixed(0)}`;
        const percentage = (ratio * 100).toFixed(7).replace(/\.?0+$/, '');
        const minSpecimens = Math.ceil(1 / ratio);

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${gender}</td>
            <td>${phenotype}</td>
            <td>${shortGenotype}</td>
            <td>${fraction} = ${percentage}%, minimum offspring to breed: ${minSpecimens}</td>
        `;
        summaryTableBody.appendChild(row);
    };

    maleOffspring.forEach(offspring => {
        addSummaryRow('Male', removeUnusedAlleles(offspring.phenotype), offspring.genotype, offspring.ratio);
    });

    femaleOffspring.forEach(offspring => {
        addSummaryRow('Female', removeUnusedAlleles(offspring.phenotype), offspring.genotype, offspring.ratio);
    });
}


window.addEventListener('DOMContentLoaded', function() {
resetCalculator();
});

document.addEventListener('DOMContentLoaded', function () {
updateSireFavoritesDropdown();
updateDamFavoritesDropdown();
resetCalculator();
});

window.addEventListener('DOMContentLoaded', function () {
updateSireFavoritesDropdown();
updateDamFavoritesDropdown();
resetCalculator();
});

function showPopupMessage(message) {
    const popup = document.createElement('div');
    popup.textContent = message;
    popup.style.position = 'fixed';
    popup.style.top = '50%';
    popup.style.left = '50%';
    popup.style.transform = 'translate(-50%, -50%)';
    popup.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
    popup.style.color = 'white';
    popup.style.padding = '20px';
    popup.style.borderRadius = '5px';
    popup.style.zIndex = '1000';
    popup.style.textAlign = 'center';

    document.body.appendChild(popup);

    setTimeout(() => {
        popup.remove();
    }, 1000); // Removes the popup after 1 second
}

function resetCalculator(initial = false) {
  const defaultGenotypes = {
    sireAlleleb: 'bb',
    sireAlleleC: 'CC',
    sireAlleled: 'dd',
    sireAlleleE: 'EE',
    sireAlleleN: 'NN',
    sireAllelePn: 'PnPn',
    sireAlleleR: 'RR',
    sireAlleleSl: 'SlSl',
    sireAlleleSp: 'SpSp',
    damAlleleb: 'bb',
    damAlleleC: 'CC',
    damAlleled: 'dd',
    damAlleleE: 'E-',
    damAlleleN: 'N-',
    damAllelePn: 'PnPn',
    damAlleleR: 'RR',
    damAlleleSl: 'SlSl',
    damAlleleSp: 'SpSp'
  };
  
  // Clear the variety text boxes
  resetVarietyAutocomplete();

  // Reset dropdowns
  Object.keys(defaultGenotypes).forEach(function(id) {
    document.getElementById(id).value = defaultGenotypes[id];
  });

  // Reset favorites
  document.getElementById('sireFavoritesDropdown').selectedIndex = 0;
  document.getElementById('damFavoritesDropdown').selectedIndex = 0;

  // Refresh genotypes + images
  updateSireGenotype();
  updateDamGenotype();

  // Clear results + chart
  document.getElementById('maleOffspringResults').innerHTML = '';
  document.getElementById('femaleOffspringResults').innerHTML = '';
  clearSummaryChart();

  if (!initial) {
    showPopupMessage('Calculator Reset');
    playSound('resetSound');  // reset sound always plays
  }
}


function initialSetup() {
    resetCalculator(true);
}

// Calls initialSetup when the DOM is loaded
window.addEventListener('DOMContentLoaded', function() {
    initialSetup();
});

</script>
  
  

 <div id="shareSection"></div>
  <br>

<script type="text/javascript" src="https://pub40.bravenet.com/counter/code.php?id=410845&amp;usernum=3351720541&amp;cpv=3"></script>

<footer style="text-align: center; margin-top: 40px;">
  &copy; 2025 Porter's Rare Heritage Turkeys
</footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const menuToggle = document.querySelector('.menu-toggle');
    const navLinks = document.querySelector('.menu-bar');

    menuToggle.addEventListener('click', function() {
        navLinks.classList.toggle('active');  // Toggle active class
    });
});



// Function to play a sound
function playSound(audioId) {
    const audio = document.getElementById(audioId);
    if (audio) {
        audio.currentTime = 0; // Reset the audio to the start
        audio.play().catch(err => console.error(`Error playing sound ${audioId}:`, err)); // Handle play errors
    }
}


/* ===============================
   Hardened Paywall Wrapper (Cookies)
   =============================== */

// ---- Cookie helpers ----
function setCookie(name, value, hours) {
  const expires = new Date(Date.now() + hours * 3600000).toUTCString();
  document.cookie = `${encodeURIComponent(name)}=${encodeURIComponent(String(value))}; expires=${expires}; path=/; SameSite=Lax`;
}
function getCookie(name) {
  const target = encodeURIComponent(name) + '=';
  const found = document.cookie.split(';').map(s => s.trim()).find(s => s.startsWith(target));
  return found ? decodeURIComponent(found.slice(target.length)) : null;
}
function deleteCookie(name) {
  document.cookie = `${encodeURIComponent(name)}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; SameSite=Lax`;
}

// ---- Debug toggle ----
const PAY_DEBUG = true;
function dbg(...args){ if(PAY_DEBUG) console.log('[PAY]', ...args); }

// Save the original calculateOffspring
if (typeof window.calculateOffspring === "function") {
  window._realCalculateOffspring = window.calculateOffspring;
}

// =====================================================
// Unlock Helpers
// =====================================================

// Generic helper: makes a Firebase-safe key from a username or email
function makeFirebaseSafeKey(id) {
  return (id || "")
    .trim()
    // Firebase RTDB keys cannot contain: . # $ [ ] /
    .replace(/[.#$/[\]/]/g, "_");
}

// Save unlock to Firebase + set cookie
async function saveUnlock(userId, type) {
  const now = Date.now();
  let expires = null;

  // Hour-based access
  if (type === "24h") expires = now + 24 * 3600000;
  if (type === "48h") expires = now + 48 * 3600000;
  if (type === "72h") expires = now + 72 * 3600000;

  // Day-based access
  if (type === "30day") expires = now + 30 * 24 * 3600000;
  if (type === "60day") expires = now + 60 * 24 * 3600000;
  if (type === "90day") expires = now + 90 * 24 * 3600000;

  // Year-based access
  if (type === "1year") expires = now + 365 * 24 * 3600000;
  if (type === "2year") expires = now + 365 * 2 * 24 * 3600000;
  if (type === "3year") expires = now + 365 * 3 * 24 * 3600000;

  if (!expires) {
    console.error("[PAY] Unknown unlock type:", type);
    return;
  }

  const trimmedId = (userId || "").trim();
  const safeKey   = makeFirebaseSafeKey(trimmedId);
  const dbPath    = "users/" + safeKey;

  
  await set(ref(db, dbPath), {
    unlockType: type,
    userId: trimmedId, // EXACT string they typed
    expires,
    expiresReadable: new Date(expires).toLocaleString()
  });

  deleteCookie("calcCount");
  deleteCookie("blockedUntil");

  const hoursLeft = Math.max(1, Math.ceil((expires - now) / 3600000));
  setCookie("paidUntil", String(expires), hoursLeft);
}

  
  
// Manual unlock from username OR email with retry if Firebase not synced yet
async function manualUnlock() {
  const idInput = document.getElementById("unlockEmail");
  const status  = document.getElementById("unlockStatus");
  const rawId   = (idInput?.value || "").trim();

  if (!rawId) {
    if (status) {
      status.style.color = "red";
      status.textContent = "❌ Please enter a username or email.";
    }
    return;
  }

  const safeKey = makeFirebaseSafeKey(rawId);

  try {
    const snap = await window.get(window.ref(window.db, "users/" + safeKey));

    if (!snap.exists()) {
      if (status) {
        status.style.color = "red";
        status.textContent = "❌ No active access found for that username/email.";
      }
      playSound?.("errorSound");
      return;
    }

    const data = snap.val();
    const now  = Date.now();

    if (typeof data.expires !== "number") {
      if (status) {
        status.style.color = "red";
        status.textContent = "❌ Account problem: missing/invalid expiry. Please contact support.";
      }
      return;
    }

    if (now >= data.expires) {
      if (status) {
        status.style.color = "red";
        status.textContent = "❌ Unlock expired. Please donate again.";
      }
      playSound?.("errorSound");
      return;
    }

    // Grant access
    if (status) {
      status.style.color = "green";
      status.textContent = "✅ Access granted. Calculator unlocked!";
    }
    playSound?.("successSound");
    const popup = document.getElementById("donationPopup");
    if (popup) popup.style.display = "none";

    // Clear free-use cookies and set paidUntil
    deleteCookie("calcCount");
    deleteCookie("blockedUntil");
    const hoursLeft = Math.max(1, Math.ceil((data.expires - now) / 3600000));
    setCookie("paidUntil", String(data.expires), hoursLeft);

    // Show live countdown + thank you (reusing your existing helpers)
    showLiveCountdown(data.expires);

    const remainingMs      = data.expires - now;
    const remainingSeconds = Math.floor(remainingMs / 1000);
    const totalDays        = Math.floor(remainingSeconds / (24 * 3600));
    const years            = Math.floor(totalDays / 365);
    const days             = totalDays % 365;
    const hours            = Math.floor((remainingSeconds % (24 * 3600)) / 3600);
    const minutes          = Math.floor((remainingSeconds % 3600) / 60);

    let parts = [];
    if (years > 0) parts.push(`${years}y`);
    if (years > 0 || days > 0) parts.push(`${days}d`);
    parts.push(`${hours}h ${minutes}m`);
    const timeMsg = parts.join(" ");

    showThankYou(`
      <span style="font-size:20px; font-weight:bold; color:white;">✅ Thank you for your donation!</span><br><br>
      <span style="color:white; font-size:16px; font-weight:bold;">
        This calculator is now unlocked. Your paid access time remaining:
      </span><br>
      <span style="background:white; color:red; font-size:18px; font-weight:bold; padding:4px 8px; border-radius:4px; display:inline-block; margin-top:6px;">
        ${timeMsg}
      </span>
    `);

  } catch (err) {
    console.error("[manualUnlock] error:", err);
    if (status) {
      status.style.color = "red";
      status.textContent = "❌ Network error. Please try again.";
    }
  }
}


   
// Check access (not always used but safe to keep)
async function checkAccess(userId) {
  const dbPath = "users/" + makeFirebaseSafeKey(userId);
  const snapshot = await get(child(dbRef, dbPath));
  if (snapshot.exists()) {
    const data = snapshot.val();
    if (data.expires && Date.now() < data.expires) return true;
  }
  return false;
}

// =====================================================
// Thank-you + Popups
// =====================================================

function showThankYou(message) {
  
  const existing = document.getElementById("customThankYouPopup");
  if (existing) existing.remove();

  const popup = document.createElement("div");
  popup.id = "customThankYouPopup";
  
  // Mobile-first, fully responsive layout
  Object.assign(popup.style, {
    position: "fixed",
    inset: "0",
    background: "rgba(0,0,0,0.75)",
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    zIndex: "100000",
    padding: "15px",
    boxSizing: "border-box"
  });

  popup.innerHTML = `
    <div style="
      background:#1E82E6;
      color:white;
      padding:20px 25px;
      border-radius:15px;
      border:4px solid tan;
      text-align:center;
      max-width:95vw;
      width:380px;
      box-shadow:0 0 30px rgba(0,0,0,0.7);
      font-size:18px;
      line-height:1.5;
    ">
      ${message}
      <br><br>
      <button id="thankyouCloseBtn" style="
        padding:12px 28px;
        background:black;
        color:white;
        border:none;
        border-radius:8px;
        cursor:pointer;
        font-weight:bold;
        font-size:17px;
        min-width:120px;
      ">Close</button>
    </div>
  `;

  document.body.appendChild(popup);

  // One-click close (only ever binds once)
  popup.querySelector("#thankyouCloseBtn").addEventListener("click", () => {
    popup.style.opacity = "0";
    setTimeout(() => popup.remove(), 600);
  }, { once: true });

  // Optional: tap anywhere outside the blue box to close
  popup.addEventListener("click", e => {
    if (e.target === popup) popup.querySelector("#thankyouCloseBtn").click();
  });
}

// Donation popup (patched so it never shows for paid users)
function showDonationPopup() {
  const now = Date.now();
  const paidUntil = parseInt(getCookie("paidUntil") || "0", 10);

  // Stop immediately if user is already paid
  if (paidUntil && now < paidUntil) {
    dbg("Bypassing donation popup for paid user until", new Date(paidUntil).toLocaleString());
    return;
  }

  const popup = document.getElementById("donationPopup");
  if (!popup) {
    console.error("[PAY] donationPopup element not found!");
    return;
  }

  const emailInput = document.getElementById("unlockEmail");
  const status = document.getElementById("unlockStatus");
  if (emailInput) emailInput.value = "";
  if (status) {
    status.textContent = "";
    status.style.color = "green";
  }

 //  Donation / Paywall Messages (with Twemoji image icons for full compatibility)
const donationMessages = [
  "<img src='https://twemoji.maxcdn.com/v/latest/72x72/1f983.png' alt='🦃' style='width:22px;height:22px;vertical-align:middle;margin-right:4px;'> \
  <strong><span style='color:red; font-size:22px;'>Free calculation limit reached.</span></strong><br> \
  With over 30 years devoted to understanding turkey color genetics, this tool helps breeders everywhere — your support helps keep it running!",

  "<img src='https://twemoji.maxcdn.com/v/latest/72x72/1f31f.png' alt='🌟' style='width:22px;height:22px;vertical-align:middle;margin-right:4px;'> \
  <strong><span style='color:red; font-size:22px;'>You've used up your free calculations.</span></strong><br> \
  Countless hours and knowledge went into this tool—please help support the effort behind this calculator.",

  "<img src='https://twemoji.maxcdn.com/v/latest/72x72/2764.png' alt='❤️' style='width:22px;height:22px;vertical-align:middle;margin-right:4px;'> \
  <strong><span style='color:red; font-size:22px;'>Free access limit reached.</span></strong><br> \
  A great deal of time and expertise went into this calculator—your support helps recognize all that effort.",

  "<img src='https://twemoji.maxcdn.com/v/latest/72x72/1f4da.png' alt='📚' style='width:22px;height:22px;vertical-align:middle;margin-right:4px;'> \
  <strong><span style='color:red; font-size:22px;'>Free calculations completed.</span></strong><br> \
  This calculator represents over 30 years of genetic research and experience — your support ensures it stays online and continues to grow!",
  
  "<img src='https://twemoji.maxcdn.com/v/latest/72x72/1f983.png' alt='🦃' style='width:22px;height:22px;vertical-align:middle;margin-right:4px;'> \
  <strong><span style='color:red; font-size:22px;'>Free calculation limit reached.</span></strong><br> \
  This calculator is the result of hours of work and knowledge—please show your appreciation for the effort behind it"
  
  ];

 // Check if there’s a saved index in localStorage
let currentMessageIndex = parseInt(localStorage.getItem('donationMessageIndex')) || 0;

const msgElem = document.getElementById("donationMessage");
if (msgElem) {
  msgElem.style.fontSize = "17px";  // <-- makes all text larger
  msgElem.innerHTML = donationMessages[currentMessageIndex];

  // Increment index for next load and save it
  currentMessageIndex = (currentMessageIndex + 1) % donationMessages.length;
  localStorage.setItem('donationMessageIndex', currentMessageIndex);
}



  popup.style.display = "block";
}


// Popup helpers
function closeDonationPopup() {
  const popup = document.getElementById("donationPopup");
  const emailInput = document.getElementById("unlockEmail");
  const status = document.getElementById("unlockStatus");
  if (emailInput) emailInput.value = "";
  if (status) status.textContent = "";
  popup.style.display = "none";
}
function resetUnlockEmail() {
  const emailInput = document.getElementById("unlockEmail");
  const status = document.getElementById("unlockStatus");
  if (emailInput) emailInput.value = "";
  if (status) {
    status.textContent = "";
    status.style.color = "green";
  }
}

// =====================================================
// Handle PayPal return (?unlock=...)
// =====================================================
document.addEventListener("DOMContentLoaded", function () {
  const urlParams = new URLSearchParams(window.location.search);
  const unlock = (urlParams.get("unlock") || "").toLowerCase();

  // Support all durations
  const validUnlocks = [
    "24h", "48h", "72h",
    "30day", "60day", "90day",
    "1year", "2year", "3year"
  ];

  // Map to labels
  const typeLabels = {
    "24h":   "24-Hour",
    "48h":   "48-Hour",
    "72h":   "72-Hour",

    "30day": "30-Day",
    "60day": "60-Day",
    "90day": "90-Day",

    "1year": "1-Year",
    "2year": "2-Year",
    "3year": "3-Year"
  };

  if (validUnlocks.includes(unlock)) {
    localStorage.setItem("pendingUnlock", unlock);

    const msgElem = document.getElementById("donationMessage");
    if (msgElem) {
      const label = typeLabels[unlock] || unlock;
      msgElem.innerHTML = `✅ Payment confirmed for <strong>${label}</strong> unlimited access.<br>
                           Please enter your email below to register and activate access.`;
    }

    const popup = document.getElementById("donationPopup");
    if (popup) popup.style.display = "block";

    const unlockBtn =
      document.getElementById("unlockEmailBtn") ||
      document.querySelector('#donationPopup button[onclick="manualUnlock()"]');

    if (unlockBtn) {
      unlockBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        e.stopImmediatePropagation();

        const emailEl = document.getElementById("unlockEmail");
        const status  = document.getElementById("unlockStatus");
        const email   = (emailEl?.value || "").trim();

        if (!email) {
          if (status) {
            status.style.color = "red";
            status.textContent = "❌ Please enter an email.";
          }
          return;
        }

        try {
          await saveUnlock(email, unlock);
          await manualUnlock();
        } catch (err) {
          console.error("[PAY] Unlock process failed:", err);
          if (status) {
            status.style.color = "red";
            status.textContent = "❌ Error saving unlock. Please try again.";
          }
        }
      }, { once: true });
    }

    history.replaceState({}, document.title, location.pathname);
  }
});



// =====================================================
// Universal Persistent Storage Helpers (Cookie + LocalStorage)
// =====================================================

// Set Cookie — stores value in both localStorage and a persistent HTTPS cookie
function setCookie(name, value, hours) {
  try {
    // localStorage fallback (Safari-safe)
    localStorage.setItem(name, value);
  } catch (e) {
    console.warn("[PAY] localStorage write failed:", e);
  }

  // create real cookie with expiration and Secure flag
  const d = new Date();
  d.setTime(d.getTime() + hours * 60 * 60 * 1000);
  const expires = "expires=" + d.toUTCString();
  document.cookie = `${name}=${value}; ${expires}; path=/; Secure; SameSite=Lax`;
}

// Get Cookie — reads from localStorage first, then cookie if not found
function getCookie(name) {
  try {
    const local = localStorage.getItem(name);
    if (local !== null && local !== undefined) return local;
  } catch (e) {
    console.warn("[PAY] localStorage read failed:", e);
  }

  const nameEQ = name + "=";
  const ca = document.cookie.split(";");
  for (let c of ca) {
    while (c.charAt(0) === " ") c = c.substring(1);
    if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length);
  }
  return "";
}

// Delete Cookie — removes value from both cookie and localStorage
function deleteCookie(name) {
  try {
    localStorage.removeItem(name);
  } catch (e) {
    console.warn("[PAY] localStorage remove failed:", e);
  }
  document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; Secure; SameSite=Lax`;
}



// =====================================================
// Paywall Wrapper
// =====================================================
// --- Wrapper with auto-retry for Firefox/Edge ---
function calculateOffspringWrapper() {
  const now = Date.now();
  const paidUntil = parseInt(getCookie("paidUntil") || "0", 10);

  // Small helper to actually run the calculation if ready
  const tryCalc = () => {
    if (typeof window._realCalculateOffspring === "function") {
      // Paid users bypass paywall
      if (paidUntil && now < paidUntil) {
        console.log("[PAY] Paid unlock active until", new Date(paidUntil).toLocaleString());
        window._realCalculateOffspring();
        playSound?.('calSound');
        return true;
      }
      
      
      
     // =====================================================
// Cookie Utilities (persistent, site-wide, 90-day default)
// =====================================================
function setCookie(name, value, hours) {
  const d = new Date();
  d.setTime(d.getTime() + hours * 60 * 60 * 1000);
  const expires = "expires=" + d.toUTCString();
  // site-wide cookie, safe across reloads and modern browsers
  document.cookie = `${name}=${value}; ${expires}; path=/; SameSite=Lax`;
}

function getCookie(name) {
  const n = name + "=";
  const decoded = decodeURIComponent(document.cookie);
  const parts = decoded.split(";");
  for (let part of parts) {
    while (part.charAt(0) === " ") part = part.substring(1);
    if (part.indexOf(n) === 0) return part.substring(n.length);
  }
  return "";
}

function deleteCookie(name) {
  document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Lax`;
}
 
      
      
// =====================================================
      // Grace Counter Reset Logic — ensures new grace each renewal
      // =====================================================
      const lastPaidUntil = parseInt(getCookie("lastPaidUntil") || "0", 10);
      if (paidUntil > lastPaidUntil) {
        // User has purchased new access since last time we saw them
        console.log("[PAY] Detected new purchase — resetting grace counter.");
        setCookie("graceCalcCount", 0, 90 * 24);
        setCookie("lastPaidUntil", paidUntil, 90 * 24);
      }
      
      
     // =====================================================
// Grace Period — 4 complimentary post-expiry calculations
// =====================================================
let graceCalcCount = parseInt(getCookie("graceCalcCount") || "0", 10);
if (!Number.isFinite(graceCalcCount) || graceCalcCount < 0) graceCalcCount = 0;
const graceLimit = 4;
const hasEverPaid = !!paidUntil;
const isExpired = hasEverPaid && now > paidUntil;
const graceActive = isExpired && graceCalcCount < graceLimit;

//Reset counter when new paid access is detected
if (hasEverPaid && now < paidUntil && graceCalcCount > 0) {
  console.log("[PAY] Paid access renewed — resetting grace counter.");
  setCookie("graceCalcCount", 0, 90 * 24);
  graceCalcCount = 0;
  deleteCookie("graceNoticeShown");
}


// Active grace period
if (graceActive) {
  // show correct number *before increment*
  const currentNum = graceCalcCount + 1;
  const remaining = graceLimit - currentNum;

  //  Rotating message system — keeps it from feeling repetitive
let graceMessage = "";

if (currentNum === 1) {
  graceMessage = `
    <strong>Complimentary Access Active</strong><br><br>
    Your paid access has expired — here's some free calculations as a thank you.<br><br>
    <em>Calculation #${currentNum} of ${graceLimit}</em><br>
    <b>${remaining >= 0 ? remaining : 0} remaining</b>
  `;
} else if (currentNum === graceLimit) {
  graceMessage = `
    <strong>Final Complimentary Calculation</strong><br><br>
We hope you’ve enjoyed your complimentary access!  
Please consider supporting Porter's Turkey Color Calculator again.<br><br>
<em>#${currentNum} of ${graceLimit}</em>

  `;
} else {
  
  // Rotating message system — randomized order, no back-to-back repeats
let shortPhrases = [
  "We appreciate your past support — enjoy this complimentary calculation.",
  "Thanks for being a loyal user — please enjoy this complimentary access.",
  "Thanks for coming back — enjoy this complimentary calculation.",
  "Your past support means a lot — enjoy this calculation on us",
  "Another free calculation to help with your breeding plans.",
  "Thanks for returning — enjoy this complimentary calculation.",
  "Thanks for supporting Porter's Turkey Color Calculator!",
  "A little thank-you for using Porter's Turkey Color Calculator."
];

// Shuffle phrases only once per new grace session
let storedOrder = getCookie("graceMsgOrder");
let order;
if (storedOrder) {
  try { order = JSON.parse(storedOrder); } catch { order = []; }
}
if (!order || !Array.isArray(order) || order.length !== shortPhrases.length) {
  order = [...shortPhrases.keys()].sort(() => Math.random() - 0.5);
  setCookie("graceMsgOrder", JSON.stringify(order), 90 * 24);
}

// Track which index we're on this session
let msgIndex = parseInt(getCookie("graceMsgIndex") || "0", 10);
if (msgIndex >= order.length) msgIndex = 0;

// Get the next phrase using the shuffled order
const randomPhrase = shortPhrases[order[msgIndex]];

// Save next index for next time
setCookie("graceMsgIndex", msgIndex + 1, 90 * 24);

graceMessage = `
  <strong>${randomPhrase}</strong><br><br>
  <em>Calculation #${currentNum} of ${graceLimit}</em><br>
  <b>${remaining >= 0 ? remaining : 0} remaining</b>
`;

}


  // Build popup
  const popup = document.createElement("div");
  popup.innerHTML = `
    <div style="
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
      pointer-events:none;">  

      <div id="gracePopup" style="
        pointer-events:auto;
        background:#1E82E6;
        color:white;
        padding:18px 20px;
        border-radius:10px;
        box-shadow:0 4px 8px rgba(0,0,0,0.3);
        font-size:1.05em;
        text-align:center;
        width:80%;
        max-width:380px;
        opacity:1;
        transition:opacity 1s ease-out;
      ">
        ${graceMessage}
      </div>
    </div>
  `;
  document.body.appendChild(popup);

  // fade away automatically
  setTimeout(() => {
    const inner = popup.querySelector("#gracePopup");
    if (inner) inner.style.opacity = "0";
    setTimeout(() => popup.remove(), 1000);
  }, 4000);


  // only increment AFTER the real calc has run
  setTimeout(() => {
    setCookie("graceCalcCount", graceCalcCount + 1, 90 * 24);
  }, 1000);

  console.log(`[PAY] Grace calculation #${currentNum} of ${graceLimit}`);
  window._realCalculateOffspring?.();
  playSound?.('calSound');
  return true;
}

// Grace fully used — block and show paywall
if (isExpired && graceCalcCount >= graceLimit) {
  console.log("[PAY] Grace period exhausted — showing paywall");
  showDonationPopup();
  playSound?.('resetSound');
  return true;
}
      

      // ---- Free-use flow ----
      let calcCount = parseInt(getCookie("calcCount") || "0", 10);
      if (!Number.isFinite(calcCount) || calcCount < 0) calcCount = 0;
      const blockedUntil = parseInt(getCookie("blockedUntil") || "0", 10);

      if (blockedUntil && now < blockedUntil) {
        showDonationPopup();
        playSound?.('errorSound');
        return true;
      }

      if (calcCount < 2) {
  calcCount++;
  setCookie("calcCount", calcCount, 30 * 24 * 3); // 3 months = 2160 hours
  console.log("[PAY] Free calc allowed. New calcCount =", calcCount);
  window._realCalculateOffspring();
  playSound?.('calSound');
  return true;
}

// Over the free limit (3-month lockout)
const threeMonthsMs = 90 * 24 * 3600000; // 90 days in milliseconds
setCookie("blockedUntil", now + threeMonthsMs, 90 * 24); // cookie valid 90 days
showDonationPopup();
playSound?.('resetSound');
return true;

}

    return false;
  };

  // Try immediately, retry if not ready
  if (!tryCalc()) {
    console.warn("[PAY] Core not ready, retrying...");
    let retries = 0;
    const timer = setInterval(() => {
      if (tryCalc() || ++retries > 10) clearInterval(timer);
    }, 200); // retry every 200ms
  }
}

// =====================================================
// Hook wrapper to button
// =====================================================
document.addEventListener("DOMContentLoaded", function() {
  const calcBtn = document.querySelector('button[onclick="calculateOffspringWrapper()"]');
  if (calcBtn) {
    dbg("Button hooked to wrapper");
    calcBtn.onclick = calculateOffspringWrapper;
  } else {
    console.warn("[PAY] Calculate Offspring button not found!");
  }
});

// =====================================================
// Add allele click sounds
// =====================================================
sireAlleles.forEach(select => {
  select.addEventListener('change', () => playSound('alleleClickSound'));
});
damAlleles.forEach(select => {
  select.addEventListener('change', () => playSound('alleleClickSound'));
});


// --- safety net for Firefox/Edge ---
window.addEventListener("load", function() {
  const calcBtn = document.querySelector('button[onclick="calculateOffspringWrapper()"]');
  if (calcBtn) {
    calcBtn.removeAttribute("onclick"); // prevent stale inline binding
    calcBtn.addEventListener("click", calculateOffspringWrapper);
    console.log("[PAY] Safety net hooked Calculate Offspring button");
  } else {
    console.error("[PAY] Calculate button not found!");
  }
});



/* ==============================
   CORE WATCHDOG (self-healing)
   Keeps searching for the real calculateOffspring and captures it when available.
 
============================== */
(function coreWatchdog() {
  let tries = 0;
  const maxTries = 60;   // up to ~12s (60 * 200ms)
  const intervalMs = 200;

  const tick = () => {
    // If the real core finally exists, capture it and stop
    if (typeof window.calculateOffspring === "function") {
      window._realCalculateOffspring = window.calculateOffspring;
      console.log("[PAY] Core located & captured by watchdog.");
      return;
    }

    // Keep waiting a bit longer
    if (++tries <= maxTries) {
      setTimeout(tick, intervalMs);
    } else {
      console.warn("[PAY] Core not found after waiting. (Extensions/ETP may be blocking it)");
    }
  };

  // Start polling after full load, and also immediately
  window.addEventListener("load", tick);
  tick();
})();

/* ==============================
    Rebind the button via addEventListener
   (ignores any stale inline onclick)
============================== */
window.addEventListener("load", function() {
  const calcBtn = document.querySelector('button[onclick="calculateOffspringWrapper()"]');
  if (calcBtn) {
    calcBtn.removeAttribute("onclick");
    calcBtn.addEventListener("click", calculateOffspringWrapper);
    console.log("[PAY] Final safety net hooked Calculate Offspring button");
  } else {
    console.error("[PAY] Calculate button not found!");
  }
});

/* ==============================
   ERROR VISIBILITY 
   ============================== */
window.addEventListener("error", (e) => {
  console.error("[JS ERROR]", e.message, "at", e.filename + ":" + e.lineno + ":" + e.colno);
});
window.addEventListener("unhandledrejection", (e) => {
  console.error("[PROMISE REJECTION]", e.reason);
});



// Save unlock to Firebase after payment
async function registerAndUnlock(email, type) {
  const now = Date.now();
  let expires = null;

  // Hour-based access
  if (type === "24h")   expires = now + 24 * 3600000;
  if (type === "48h")   expires = now + 48 * 3600000;
  if (type === "72h")   expires = now + 72 * 3600000;

  // Day-based access
  if (type === "30day") expires = now + 30 * 24 * 3600000;
  if (type === "60day") expires = now + 60 * 24 * 3600000;
  if (type === "90day") expires = now + 90 * 24 * 3600000;

  // Year-based access
  if (type === "1year") expires = now + 365 * 24 * 3600000;
  if (type === "2year") expires = now + 365 * 2 * 24 * 3600000;
  if (type === "3year") expires = now + 365 * 3 * 24 * 3600000;

  if (!expires) {
    console.error("[PAY] Unknown unlock type:", type);
    return;
  }
  
    const trimmedId = (email || "").trim();
  const safeKey   = makeFirebaseSafeKey(trimmedId);
  const dbPath    = "users/" + safeKey;

  await set(ref(db, dbPath), { 
    unlockType: type, 
    userId: trimmedId,
    expires,
    expiresReadable: new Date(expires).toLocaleString()
  });

  

  deleteCookie("calcCount");
  deleteCookie("blockedUntil");
  
  const hoursLeft = Math.max(1, Math.ceil((expires - now) / 3600000));
  setCookie("paidUntil", String(expires), hoursLeft);
}

// --- Hotfix: re-bind calculate button and allele sounds after all scripts load ---
window.addEventListener("load", () => {
  // If the real core exists, capture it (needed for Firefox/Edge cases)
  if (typeof window.calculateOffspring === "function") {
    window._realCalculateOffspring = window.calculateOffspring;
  }

  // Ensure the Calculate button is bound to the wrapper
  const btn = document.querySelector('button[onclick="calculateOffspringWrapper()"]');
  if (btn) {
    btn.removeAttribute("onclick");
    btn.addEventListener("click", calculateOffspringWrapper);
  }

  // Re-attach allele click sounds (robust)
  const playAllele = () => playSound && playSound("alleleClickSound");
  document
    .querySelectorAll(".sire-genotypes select, .dam-genotypes select")
    .forEach((sel) => sel.addEventListener("change", playAllele));
  
  console.log("[PAY] Hotfix: calc button + allele sounds bound");
});



 function showLiveCountdown(expires) {
  // Remove old countdown if it exists
  let existing = document.getElementById("liveCountdownBox");
  if (existing) existing.remove();

  // Create minimized box (black background, white border)
  const box = document.createElement("div");
  box.id = "liveCountdownBox";
  Object.assign(box.style, {
    position: "fixed",
    bottom: "20px",
    left: "20px",
    background: "black",
    color: "white",
    fontWeight: "bold",
    fontSize: "14px",
    padding: "6px 12px",
    borderRadius: "6px",
    border: "2px solid white",
    zIndex: "9999",
    cursor: "pointer",
    boxShadow: "0 2px 6px rgba(0,0,0,0.3)",
    transition: "all 0.3s ease"
  });
  box.textContent = "⏳ Access";

  // Expanded content (red background, white border)
  const expanded = document.createElement("div");
  Object.assign(expanded.style, {
    display: "none",
    marginTop: "6px",
    background: "red",         
    color: "black",            
    padding: "6px 10px",
    borderRadius: "6px",
    border: "2px solid white", 
    fontSize: "14px",
    textAlign: "center",
    fontWeight: "bold"
  });

  // NON-LIFETIME template: INNER white/blue VIP-style box with countdown
  expanded.innerHTML = `
    <div class="vipBoxNonLifetime">
      ⏳ Paid access time remaining:<br>
      <span id="countdownTimer">--</span>
    </div>

    <style>
      /* Reuses same style as lifetime vipBox */

      @keyframes vipFadeInNL {
        0%   { opacity: 0; transform: translateY(6px) scale(0.97); }
        70%  { opacity: 1; transform: translateY(0) scale(1.02); }
        100% { opacity: 1; transform: translateY(0) scale(1); }
      }

      @keyframes vipPulseNL {
        0%, 100% { box-shadow: 0 0 8px rgba(30,130,230,0.35); }
        50%      { box-shadow: 0 0 14px rgba(30,130,230,0.55); }
      }

      @keyframes vipSparkleNL {
        0%   { background-position: -220px 0; }
        100% { background-position: 220px 0; }
      }

      .vipBoxNonLifetime {
        background: white;          /* INNER white */
        color: #1E82E6;             /* blue text */
        font-weight: bold;
        font-size: 14px;
        text-align: center;
        padding: 6px 8px;
        border-radius: 6px;
        border: 2px solid #1E82E6;  /* INNER blue border */

        opacity: 0;

        /* shimmer over white */
        background-image: linear-gradient(
          90deg,
          rgba(255,255,255,0.0) 0%,
          rgba(255,255,255,0.20) 50%,
          rgba(255,255,255,0.0) 100%
        );
        background-size: 220px 100%;

        animation:
          vipFadeInNL 0.75s ease forwards,
          vipPulseNL 2.8s ease-in-out infinite,
          vipSparkleNL 3.2s linear infinite;
      }
    </style>
  `;

  box.appendChild(expanded);
  document.body.appendChild(box);

  // Hover to show/hide expanded (both lifetime & non-lifetime)
  box.addEventListener("mouseenter", () => {
    expanded.style.display = "block";
  });
  box.addEventListener("mouseleave", () => {
    expanded.style.display = "none";
  });

  // Lifetime threshold (80+ years)
  const LIFETIME_THRESHOLD = 29000;

    function updateCountdown() {
    const now = Date.now();
    const diff = expires - now;
    const timerEl = document.getElementById("countdownTimer");
    if (!timerEl) return;

    const totalSeconds = Math.floor(diff / 1000);
    const totalDays = Math.floor(totalSeconds / 86400);

    // ---------- LIFETIME ACCESS (unchanged) ----------
    if (totalDays > LIFETIME_THRESHOLD) {
      // STOP countdown permanently
      clearInterval(window.__countdownInterval);

      // Expanded Lifetime user box
      expanded.innerHTML = `
        <div class="vipBox">
          💎 VIP Lifetime Access
        </div>

        <style>
          /* Fade + Slide + Scale */
          @keyframes vipFadeIn {
            0%   { opacity: 0; transform: translateY(6px) scale(0.97); }
            70%  { opacity: 1; transform: translateY(0) scale(1.02); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
          }

          /* Soft Pulse Glow (cool blue/white) */
          @keyframes vipPulse {
            0%, 100% { box-shadow: 0 0 8px rgba(30,130,230,0.35); }
            50%      { box-shadow: 0 0 14px rgba(30,130,230,0.55); }
          }

          /* Sparkle Shimmer (subtle sweep left → right) */
          @keyframes vipSparkle {
            0%   { background-position: -220px 0; }
            100% { background-position: 220px 0; }
          }

          .vipBox {
            background: white; 
            color: #1E82E6;    
            font-weight: bold;
            font-size: 14px;
            text-align: center;
            padding: 6px 8px;
            border-radius: 6px;
            border: 2px solid #1E82E6; /* blue border */
            opacity: 0;

            background-image: linear-gradient(
              90deg,
              rgba(255,255,255,0.0) 0%,
              rgba(255,255,255,0.20) 50%,
              rgba(255,255,255,0.0) 100%
            );
            background-size: 220px 100%;

            animation:
              vipFadeIn 0.75s ease forwards,
              vipPulse 2.8s ease-in-out infinite,
              vipSparkle 3.2s linear infinite;
          }
        </style>
      `;

      return; // NEVER update again
    }
    // ---------- END LIFETIME FIX ----------

    if (diff <= 0) {
      timerEl.textContent = "Expired";
      expanded.style.display = "block";
      clearInterval(window.__countdownInterval);

      box.style.background = "gray";
      box.style.color = "white";
      box.textContent = "⏳ Expired";

      box.addEventListener("click", () => {
        const popup = document.getElementById("donationPopup");
        if (popup) popup.style.display = "block";
      }, { once: true });

      return;
    }

    // Year-aware breakdown
    const years = Math.floor(totalDays / 365);
    const days  = totalDays % 365;
    const hours = Math.floor((totalSeconds % 86400) / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;

    let label = "";
    if (years > 0) label += `${years}y `;
    label += `${days}d ${hours}h ${minutes}m ${seconds}s`;

    // NORMAL (NON-LIFETIME) ACCESS – just update the countdown text
    timerEl.textContent = label;
  }

  

  updateCountdown();
  window.__countdownInterval = setInterval(updateCountdown, 1000);
}


// =====================================================
// Restore countdown on reload if user is still paid
// =====================================================
window.addEventListener("DOMContentLoaded", () => {
  const paidUntil = parseInt(getCookie("paidUntil") || "0", 10);
  const now = Date.now();

  if (paidUntil && now < paidUntil) {
    // Active paid user – just restore countdown
    showLiveCountdown(paidUntil);
  } else {
    // No active access – see if there is a paid session waiting for registration
    recoverPendingPayment();
  }
});


// Ensure Unlock with Email button triggers manualUnlock for all users
document.addEventListener("DOMContentLoaded", () => {
  const unlockBtn = document.getElementById("unlockEmailBtn");
  if (unlockBtn) {
    unlockBtn.addEventListener("click", manualUnlock);
  }
});

// Trim 2nd line from amount buttons
document.addEventListener("click", (e) => {
  const btn = e.target.closest(".amount-btn");
  if (!btn) return;

  // Delay slightly to ensure DOM reflects the click target
  setTimeout(() => {
    const strongElem = btn.closest(".pay-option")?.querySelector("strong");
    if (!strongElem) return;

    // Remove the second line (anything after <br>)
    const html = strongElem.innerHTML;
    if (html.includes("<br>")) {
      strongElem.innerHTML = html.split("<br>")[0];
    }
  }, 10);
});


</script>

<!--  PayPal Smart Buttons SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=AVDCqtzTSIYzSsQUxg_Z0qmsycvOJB0LAISEIFobpxA0K5ZteOM3G3pAN1fkj89dS3_YSkStFbrxwHpS&amp;currency=USD&amp;disable-funding=paylater"></script>


<script>
function handlePaymentSuccess(type, details) {
  //  Remember that this browser has a paid session waiting for registration
  try {
    localStorage.setItem("pendingPaymentType", type);
  } catch (e) {
    console.warn("[PAY] Could not store pending payment:", e);
  }

  const payerName = details?.payer?.name?.given_name || "Supporter";

  // labels
  const typeLabel =
    (type === "24h")   ? "24 Hours" :
    (type === "48h")   ? "48 Hours" :
    (type === "72h")   ? "72 Hours" :

    (type === "30day") ? "30 Days" :
    (type === "60day") ? "60 Days" :
    (type === "90day") ? "90 Days" :

    (type === "1year") ? "1 Year" :
    (type === "2year") ? "2 Years" :
    (type === "3year") ? "3 Years" :

    type;

  // --- Step 1: Thank-you popup ---
  const thankyouPopup = document.createElement("div");
  Object.assign(thankyouPopup.style, {
    position: "fixed", top: "50%", left: "50%",
    transform: "translate(-50%, -50%)",
    background: "#1E82E6", color: "white",
    padding: "25px 30px", borderRadius: "15px",
    boxShadow: "0 0 20px rgba(0,0,0,0.6)",
    zIndex: "99999", textAlign: "center",
    fontSize: "1.1rem", border: "3px solid tan",
    opacity: "1", transition: "opacity 0.8s ease"
  });
  
   // Play ding sound for the thankyou popup
  playSound("successSound");
  thankyouPopup.innerHTML = `
    <p style="margin-bottom:12px; font-size:1.6rem;">
      ❤️️️️️ Thank you <b>${payerName}</b>!<br>
      Your <b>${typeLabel}</b> access has been unlocked.
    </p>

    <button id="closeThankyou" style="margin-top:8px;padding:7px 15px;background:tan;color:black;border:none;border-radius:8px;cursor:pointer;font-weight:bold;">
      OK
    </button>
  `;
  document.body.appendChild(thankyouPopup);

  // --- Step 2: open email registration modal ---
  document.getElementById("closeThankyou").onclick = () => {
    thankyouPopup.style.opacity = "0";
    setTimeout(() => thankyouPopup.remove(), 800);
    // Ding when registration modal opens
    playSound("longGenotypeSound");

    const emailModal = document.createElement("div");
    Object.assign(emailModal.style, {
      position: "fixed", top: "50%", left: "50%",
      transform: "translate(-50%, -50%)",
      background: "white", color: "black",
      padding: "25px 30px", borderRadius: "15px",
      boxShadow: "0 0 20px rgba(0,0,0,0.6)",
      zIndex: "99999", textAlign: "center",
      fontSize: "1.1rem", border: "3px solid tan",
      width: "90%", maxWidth: "400px",
      opacity: "1", transition: "opacity 0.8s ease"
    });

    emailModal.innerHTML = `
     <p style="margin-bottom:10px;">
  Register your <b>${typeLabel}</b> access:
</p>

      <input type="text" id="paymentEmail" placeholder="Enter a username or email"
        style="width:85%;padding:8px;border:2px solid #1E82E6;border-radius:6px;font-size:1rem;"><br><br>
      <button id="submitPaymentEmail"
        style="padding:7px 15px;background:#1E82E6;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:bold;">
        Submit
      </button>
    `;
    document.body.appendChild(emailModal);

    // --- Step 3: email submission handler ---
    document.getElementById("submitPaymentEmail").onclick = async () => {
      const idString = document.getElementById("paymentEmail").value.trim();
      if (!idString) {
        alert("❌ Please enter a username or email to continue.");
        return;
      }

      // fade out registration box
      emailModal.style.opacity = "0";
      setTimeout(() => emailModal.remove(), 800);

      // Keep "Already Donated" box in sync so manualUnlock() works if used
      const unlockField = document.getElementById("unlockEmail");
      if (unlockField) unlockField.value = idString;

      // Save to Firebase + cookies
      await saveUnlock(idString, type);  // stores username/email EXACT as typed
      await manualUnlock();              // immediately tests unlock with the same input

      // Clears the pending payment flag after user registers
      try {
        localStorage.removeItem("pendingPaymentType");
      } catch (e) {
        console.warn("[PAY] Could not clear pending payment:", e);
      }

      try {
        // Fade out paywall popup if it's open
        const popup = document.getElementById("donationPopup");
        if (popup) {
          popup.style.transition = "opacity 0.8s ease";
          popup.style.opacity = "0";
          setTimeout(() => popup.style.display = "none", 800);
        }

        // Immediately set cookie + show countdown
        const now = Date.now();
        let expires = null;

        if (type === "24h")   expires = now + 24 * 3600000;
        if (type === "48h")   expires = now + 48 * 3600000;
        if (type === "72h")   expires = now + 72 * 3600000;

        if (type === "30day") expires = now + 30 * 24 * 3600000;
        if (type === "60day") expires = now + 60 * 24 * 3600000;
        if (type === "90day") expires = now + 90 * 24 * 3600000;

        if (type === "1year") expires = now + 365 * 24 * 3600000;
        if (type === "2year") expires = now + 365 * 2 * 24 * 3600000;
        if (type === "3year") expires = now + 365 * 3 * 24 * 3600000;

        if (expires) {
          deleteCookie("calcCount");
          deleteCookie("blockedUntil");

          const hoursLeft = Math.max(1, Math.ceil((expires - now) / 3600000));
          setCookie("paidUntil", String(expires), hoursLeft);

          const oldBox = document.getElementById("liveCountdownBox");
          if (oldBox) oldBox.remove();

          showLiveCountdown(expires);
        }
      } catch (err) {
        console.error("[PAY] Auto-close/countdown restore error:", err);
      }
    };
  };
}


// Registration Recovery – if user paid but didn't finish registering
function recoverPendingPayment() {
  let type = null;
  try {
    type = localStorage.getItem("pendingPaymentType");
  } catch (e) {
    console.warn("[PAY] Could not read pending payment:", e);
    return;
  }

  // Nothing pending
  if (!type) return;

  // If they already have active paid access, just clears the flag 
  const paidUntil = parseInt(getCookie("paidUntil") || "0", 10);
  if (paidUntil && Date.now() < paidUntil) {
    try {
      localStorage.removeItem("pendingPaymentType");
    } catch (e) {}
    return;
  }

  const typeLabel =
    (type === "24h")   ? "24 Hours" :
    (type === "48h")   ? "48 Hours" :
    (type === "72h")   ? "72 Hours" :

    (type === "30day") ? "30 Days" :
    (type === "60day") ? "60 Days" :
    (type === "90day") ? "90 Days" :

    (type === "1year") ? "1 Year" :
    (type === "2year") ? "2 Years" :
    (type === "3year") ? "3 Years" :
    type;

  // Make sure we don't stack multiple recovery modals
  const existing = document.getElementById("paymentRecoveryModal");
  if (existing) existing.remove();

  const emailModal = document.createElement("div");
  emailModal.id = "paymentRecoveryModal";
  Object.assign(emailModal.style, {
    position: "fixed", top: "50%", left: "50%",
    transform: "translate(-50%, -50%)",
    background: "white", color: "black",
    padding: "25px 30px", borderRadius: "15px",
    boxShadow: "0 0 20px rgba(0,0,0,0.6)",
    zIndex: "99999", textAlign: "center",
    fontSize: "1.1rem", border: "3px solid tan",
    width: "90%", maxWidth: "400px",
    opacity: "1", transition: "opacity 0.8s ease"
  });

  emailModal.innerHTML = `
    <p style="margin-bottom:10px;">
      We detected a completed <b>${typeLabel}</b> payment on this device.<br>
      Please register a <b>username or email</b> so your access can be activated.<br>
      <span style="font-size:0.9rem;color:#555;">You will not be charged again.</span>
    </p>
    <input type="text" id="recoveryPaymentId" placeholder="Enter a username or email"
      style="width:85%;padding:8px;border:2px solid #1E82E6;border-radius:6px;font-size:1rem;"><br><br>
    <button id="submitRecoveryPayment"
      style="padding:7px 15px;background:#1E82E6;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:bold;">
      Submit
    </button>
  `;

  document.body.appendChild(emailModal);

  document.getElementById("submitRecoveryPayment").onclick = async () => {
    const idString = document.getElementById("recoveryPaymentId").value.trim();
    if (!idString) {
      alert("❌ Please enter a username or email to continue.");
      return;
    }

    emailModal.style.opacity = "0";
    setTimeout(() => emailModal.remove(), 800);

    // Keep "Already Donated" box in sync for manualUnlock()
    const unlockField = document.getElementById("unlockEmail");
    if (unlockField) unlockField.value = idString;

    try {
      await saveUnlock(idString, type);
      await manualUnlock();

      // Clear pending flag now that it's registered
      try {
        localStorage.removeItem("pendingPaymentType");
      } catch (e) {}

      // Mirror the same immediate cookie/countdown behavior
      const now = Date.now();
      let expires = null;

      if (type === "24h")   expires = now + 24 * 3600000;
      if (type === "48h")   expires = now + 48 * 3600000;
      if (type === "72h")   expires = now + 72 * 3600000;

      if (type === "30day") expires = now + 30 * 24 * 3600000;
      if (type === "60day") expires = now + 60 * 24 * 3600000;
      if (type === "90day") expires = now + 90 * 24 * 3600000;

      if (type === "1year") expires = now + 365 * 24 * 3600000;
      if (type === "2year") expires = now + 365 * 2 * 24 * 3600000;
      if (type === "3year") expires = now + 365 * 3 * 24 * 3600000;

      if (expires) {
        deleteCookie("calcCount");
        deleteCookie("blockedUntil");

        const hoursLeft = Math.max(1, Math.ceil((expires - now) / 3600000));
        setCookie("paidUntil", String(expires), hoursLeft);

        const oldBox = document.getElementById("liveCountdownBox");
        if (oldBox) oldBox.remove();

        showLiveCountdown(expires);
      }
    } catch (err) {
      console.error("[PAY] Recovery registration failed:", err);
      alert("❌ There was a problem saving your access. Please try again.");
    }
  };
}


// Render PayPal only after user selects a $ amount
document.querySelectorAll(".amount-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const type = btn.dataset.type;
    const value = btn.dataset.value;
    const hours = btn.dataset.hours || "";
    const container = document.getElementById("paypal-button-container-" + type);

    // Reset styling on sibling buttons
    btn.parentElement.querySelectorAll(".amount-btn").forEach(b => {
      b.classList.remove("active");
      b.style.background = "#f0f0f0";
      b.style.color = "#000";
      b.style.border = "1px solid #ccc";
    });

    // Highlight active button
    btn.classList.add("active");
    btn.style.background = "#1E82E6";
    btn.style.color = "#fff";
    btn.style.border = "1px solid tan";

    // Clear any old PayPal buttons in this container
    container.innerHTML = "";

   // Render PayPal only NOW — when user has selected a price
paypal.Buttons({
  style: { color: "blue", label: "paypal", shape: "rect", height: 38 },
  createOrder: (data, actions) => actions.order.create({
    application_context: { shipping_preference: "NO_SHIPPING" },
    purchase_units: [{
      description: `${
        hours
          ? `${hours}-Hour Calculator 2 Access`
          : type === "30day"
            ? "30-Day Calculator 2 Access"
          : type === "60day"
            ? "60-Day Calculator 2 Access"
          : type === "90day"
            ? "90-Day Calculator 2 Access"
          : type === "1year"
            ? "1-Year Calculator 2 Access"
          : type === "2year"
            ? "2-Year Calculator 2 Access"
          : type === "3year"
            ? "3-Year Calculator 2 Access"
          : `${type} Access`
      }`,
      amount: { value }
    }]
  }),

  onApprove: (data, actions) =>
    actions.order.capture().then(details => handlePaymentSuccess(type, details))

}).render("#" + container.id);

  });
});





</script>

</body>
</html
